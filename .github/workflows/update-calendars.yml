name: Update Basketball Calendars

on:
  # Run every hour during game hours (6 AM - 9 PM ET)
  # Note: GitHub Actions uses UTC, so 6 AM - 9 PM ET = 11:00 - 02:00 UTC (EST) or 10:00 - 01:00 UTC (EDT)
  # Using ET approximation: 6 AM ET ≈ 11 UTC, 9 PM ET ≈ 02 UTC
  schedule:
    - cron: '0 11-23 * * *'  # Hourly 11 AM - 11 PM UTC (6 AM - 6 PM ET)
    - cron: '0 0-2 * * *'    # Hourly midnight - 2 AM UTC (7 - 9 PM ET)
    - cron: '0 7 * * *'      # 7 AM UTC = 2 AM ET (single overnight run, ~5 hours gap)

  # Allow manual trigger with optional test modes
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode (detect changes but do not send notifications)'
        type: boolean
        default: false
      test_team:
        description: 'Send notification to team (e.g., 5-m-red). Leave empty for normal run.'
        type: string
        default: ''
      notification_message:
        description: 'Custom message (optional). If empty with test_team, sends test notification.'
        type: string
        default: ''

  # Run on push to main
  push:
    branches:
      - main
    paths:
      - 'teams.json'
      - 'scraper.py'
      - '.github/workflows/update-calendars.yml'

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  issues: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install icalendar

      - name: Fetch previous schedule state
        run: |
          # Fetch the previous schedule state from deployed site for change detection
          # This allows us to detect schedule changes between runs
          mkdir -p docs
          curl -sf "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/schedule_state.json" \
            -o docs/schedule_state.json || echo "No previous state found (first run or state not yet deployed)"

      - name: Run scraper
        run: |
          python scraper.py \
            --config teams.json \
            --output docs \
            --base-url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" \
            ${{ inputs.dry_run == true && '--dry-run' || '' }} \
            ${{ inputs.test_team != '' && format('--test-notification {0}', inputs.test_team) || '' }} \
            ${{ inputs.notification_message != '' && format('--notification-message "{0}"', inputs.notification_message) || '' }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

  deploy:
    needs: scrape
    runs-on: ubuntu-latest
    # Skip deploy for test notifications (nothing to deploy)
    if: ${{ inputs.test_team == '' || inputs.test_team == null }}

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-failure:
    needs: [scrape, deploy]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Workflow failed: Update Basketball Calendars';
            const label = 'workflow-failure';

            // Check for existing open issue with this label
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: label,
              state: 'open'
            });

            if (existingIssues.data.length > 0) {
              console.log('Open issue already exists, skipping creation');
              return;
            }

            // Create the issue with a label
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              labels: [label],
              body: `Workflow run failed on ${new Date().toISOString()}\n\n[View run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
