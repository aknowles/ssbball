name: Process Practice Changes

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  process-practice-change:
    runs-on: ubuntu-latest
    # Only runs when 'approved' label is added AND issue has 'practice-change' label
    if: github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, 'practice-change')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Process practice change
        uses: actions/github-script@v7
        id: process
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body;
            const labels = issue.labels.map(l => l.name);

            // Parse issue body (GitHub issue forms use markdown format)
            function parseField(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n#]+)`, 'i');
              const match = body.match(regex);
              if (match) {
                const value = match[1].trim();
                return value === '_No response_' || value === '' ? null : value;
              }
              return null;
            }

            const team = parseField(body, 'Team');
            const date = parseField(body, 'Practice Date');

            if (!team || !date) {
              core.setFailed('Missing required fields: team or date');
              return;
            }

            // Validate date format
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
              core.setFailed(`Invalid date format: ${date}. Expected YYYY-MM-DD`);
              return;
            }

            // Load teams.json
            const teamsJson = JSON.parse(fs.readFileSync('teams.json', 'utf8'));

            // Ensure practices section exists
            if (!teamsJson.practices) {
              teamsJson.practices = {};
            }
            if (!teamsJson.practices[team]) {
              teamsJson.practices[team] = { recurring: [], adhoc: [], modifications: [] };
            }

            let changeDescription = '';

            if (labels.includes('cancel')) {
              // Add cancellation modification
              const modification = {
                date: date,
                action: 'cancel'
              };
              const reason = parseField(body, 'Reason \\(optional\\)');
              if (reason) {
                modification.reason = reason;
              }
              teamsJson.practices[team].modifications.push(modification);
              changeDescription = `Cancelled practice for ${team} on ${date}`;

            } else if (labels.includes('modify')) {
              // Add modification
              const modification = {
                date: date,
                action: 'modify'
              };
              const newTime = parseField(body, 'New Time \\(optional\\)');
              const newDuration = parseField(body, 'New Duration \\(optional\\)');
              const newLocation = parseField(body, 'New Location \\(optional\\)');

              if (newTime) modification.time = newTime;
              if (newDuration) modification.duration = parseInt(newDuration);
              if (newLocation) modification.location = newLocation;

              if (!newTime && !newDuration && !newLocation) {
                core.setFailed('No changes specified. Please provide at least one of: new time, duration, or location');
                return;
              }

              teamsJson.practices[team].modifications.push(modification);
              const changes = [];
              if (newTime) changes.push(`time: ${newTime}`);
              if (newDuration) changes.push(`duration: ${newDuration} min`);
              if (newLocation) changes.push(`location: ${newLocation}`);
              changeDescription = `Modified practice for ${team} on ${date} (${changes.join(', ')})`;

            } else if (labels.includes('add')) {
              // Add ad-hoc practice
              const time = parseField(body, 'Start Time');
              const duration = parseField(body, 'Duration');
              const location = parseField(body, 'Location');

              if (!time || !duration || !location) {
                core.setFailed('Missing required fields for adding practice');
                return;
              }

              const adhocPractice = {
                date: date,
                time: time,
                duration: parseInt(duration),
                location: location
              };
              teamsJson.practices[team].adhoc.push(adhocPractice);
              changeDescription = `Added practice for ${team} on ${date} at ${time}`;
            } else {
              core.setFailed('Unknown practice change type. Expected cancel, modify, or add label.');
              return;
            }

            // Write updated teams.json
            fs.writeFileSync('teams.json', JSON.stringify(teamsJson, null, 2) + '\n');

            core.setOutput('change_description', changeDescription);
            core.setOutput('team', team);
            core.setOutput('date', date);

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add teams.json
          git commit -m "Practice change: ${{ steps.process.outputs.change_description }}"
          git push

      - name: Close issue with comment
        uses: actions/github-script@v7
        with:
          script: |
            const changeDescription = '${{ steps.process.outputs.change_description }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ Practice change processed successfully!\n\n**Change:** ${changeDescription}\n\nThe calendar will be updated shortly.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `❌ Failed to process practice change. Please check the issue details and try again.\n\nSee [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            });
